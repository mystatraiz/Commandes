<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name="theme-color" content="#13314D"><link id="manifest-link" rel="manifest" href="#"><title>Gestion des Commandes</title><style>
:root{--bgd:#081420;--bg:#13314D;--st:#1A2D3D;--ink:#ECDEAD;--brand:#BA914A;--mut:#446B88;--c1:#4D1B87;--c2:#ED330C;--c3:#E89F90;--c4:#825C52}
*{box-sizing:border-box}body{margin:0;padding:20px;font-family:Arial,sans-serif;background:var(--bgd);color:var(--ink)}h1{margin:0 0 10px}
.tabs{display:flex;gap:8px;margin:10px 0 16px}.tab{flex:1;text-align:center;border:1px solid var(--mut);background:transparent;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}.tab[aria-selected="true"]{background:var(--brand);color:var(--bgd);border-color:transparent;font-weight:700}.panel{display:none}.panel.active{display:block}
.topbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.card{background:var(--bg);border:1px solid var(--st);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 16px rgba(0,0,0,.2)}.center{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.btn{padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}.action{background:var(--brand);color:var(--bgd)}
.table{border-collapse:separate;border-spacing:0;width:100%;background:var(--bg);border-radius:12px;overflow:hidden;margin-top:15px;table-layout:fixed}
th{background:var(--mut);border:1px solid var(--st);padding:10px;text-align:center}
td{border:1px solid var(--st);padding:0;text-align:center;cursor:pointer;user-select:none;height:50px}
th.c1,td.c1{background:var(--c1);color:#fff}th.c2,td.c2{background:var(--c2);color:#fff}th.c3,td.c3{background:var(--c3);color:#111}th.c4,td.c4{background:var(--c4);color:#fff}
.cell{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:800;line-height:1;font-size:clamp(12px,4vw,22px)}
.ticket-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}.ticket{background:#0f2336;border:1px solid var(--st);border-radius:12px;padding:12px;box-shadow:0 6px 16px rgba(0,0,0,.25)}.ticket header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}.badge{background:var(--mut);border:1px solid var(--st);padding:2px 8px;border-radius:999px;font-size:12px}
.select{padding:8px;border-radius:8px;border:1px solid var(--mut);background:var(--bg);color:var(--ink)}
</style></head><body>
<h1>Gestion des Commandes</h1>
<div class="tabs" role="tablist"><button id="tab-s" class="tab" aria-selected="true">Saisie</button><button id="tab-t" class="tab" aria-selected="false">Tickets</button></div>
<section id="p-s" class="panel active"><div class="topbar"><label for="tbl">Table :</label><select id="tbl" class="select"><option value="">-- Sélectionner --</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>55</option><option>6</option><option>7</option><option>8</option><option>9</option><option>11</option><option>12</option><option>14</option><option>15</option><option>16</option><option>17</option><option>18</option><option>19</option><option>21</option><option>22</option><option>23</option><option>24</option><option>25</option><option>30</option><option>31</option><option>32</option><option>33</option><option>34</option><option>35</option><option>36</option><option>37</option></select><button id="send" class="btn action">Envoyer la commande</button></div>
<div class="card"><h2 style="text-align:center;margin:0 0 8px">Précuisson</h2><div class="center"><button class="btn" data-pre="Côte de boeuf">Côte de boeuf: <span id="pre-co">0</span></button><button class="btn" data-pre="T-Bone">T-Bone: <span id="pre-tb">0</span></button><button class="btn" data-pre="Tomahawk">Tomahawk: <span id="pre-th">0</span></button></div></div>
<table class="table" id="cmd"><thead><tr><th>Viande</th><th class="c1">Bleu</th><th class="c2">Saignant</th><th class="c3">À Point</th><th class="c4">Bien Cuit</th></tr></thead><tbody id="tb"></tbody></table></section>
<section id="p-t" class="panel"><div class="card"><h2 style="margin:0">Tickets – Commandes en cours</h2><div id="tickets" class="ticket-list"></div></div></section>
<script>
(()=>{
  const VIANDES=["Entrecôte","Côte de boeuf","Bavette","T-Bone","Tomahawk","Wagyu Noix","Wagyu Tomahawk","Wagyu Rib Cap","Wagyu Chateaubriand","1/2 Selle Agneau","Gigot","1/2 Poulet","Magret"];
  const CUIS=["Bleu","Saignant","À Point","Bien Cuit"]; const STK='gc_state_v1';
  const el=(s)=>document.querySelector(s), els=(s)=>[...document.querySelectorAll(s)];
  const tb=el('#tb'), ticketsEl=el('#tickets');
  let data={}, timers=new Map();
  let tickets=[], pre={"Côte de boeuf":0,"T-Bone":0,"Tomahawk":0};
  const preRefs={"Côte de boeuf":el('#pre-co'),"T-Bone":el('#pre-tb'),"Tomahawk":el('#pre-th')};
  const save=()=>localStorage.setItem(STK,JSON.stringify({tickets,pre}));
  const load=()=>{try{const x=JSON.parse(localStorage.getItem(STK)||'{}');tickets=x.tickets||[];pre=Object.assign(pre,x.pre||{});}catch{}};
  const row=(v)=>`<tr><td class="cell" style="justify-content:flex-start;padding-left:8px">${v}</td>${CUIS.map((c,i)=>`<td class="c${i+1}"><div class="cell" data-v="${v}" data-c="${c}">0</div></td>`).join('')}</tr>`;
  const renderTable=()=>{tb.innerHTML=VIANDES.map(row).join('');data={};VIANDES.forEach(v=>data[v]={Bleu:0,Saignant:0,"À Point":0,"Bien Cuit":0});}
  const renderTickets=()=>{ticketsEl.innerHTML=tickets.map(t=>`<div class="ticket"><header><div><strong>Table ${t.table}</strong> <span class="badge">${t.createdAt}</span></div><button class="btn action" data-done="${t.id}">Terminé</button></header><ul>${t.items.map(i=>`<li>${i.qty} × ${i.viande} – ${i.cuisson}</li>`).join('')}</ul></div>`).join('');};

  // Tabs
  const show=(p)=>{el('#p-s').classList.toggle('active',p==='s');el('#p-t').classList.toggle('active',p==='t');el('#tab-s').setAttribute('aria-selected',p==='s');el('#tab-t').setAttribute('aria-selected',p==='t');};
  el('#tab-s').onclick=()=>show('s'); el('#tab-t').onclick=()=>show('t');

  // Table interactions (delegation)
  const start=(e)=>{const d=e.target.closest('.cell'); if(!d||!d.dataset.c) return; const key=d.dataset.v+"|"+d.dataset.c; timers.set(key,setTimeout(()=>{data[d.dataset.v][d.dataset.c]=0; d.textContent=0; timers.delete(key);},700));};
  const end=(e)=>{const d=e.target.closest('.cell'); if(!d||!d.dataset.c) return; const key=d.dataset.v+"|"+d.dataset.c; const t=timers.get(key); if(t){clearTimeout(t); timers.delete(key); let val=++data[d.dataset.v][d.dataset.c]; if(val>99) val=99; d.textContent=val;}};
  el('#cmd').addEventListener('mousedown',start); el('#cmd').addEventListener('mouseup',end); el('#cmd').addEventListener('mouseleave',()=>{timers.forEach(clearTimeout); timers.clear();});
  el('#cmd').addEventListener('touchstart',(e)=>{const t=e.target.closest('.cell'); if(!t||!t.dataset.c) return; e.preventDefault(); start(e);},{passive:false});
  el('#cmd').addEventListener('touchend',(e)=>{const t=e.target.closest('.cell'); if(!t||!t.dataset.c) return; e.preventDefault(); end(e);},{passive:false});

  // Precuisson buttons
  els('[data-pre]').forEach(b=>b.onclick=()=>{const v=b.dataset.pre; pre[v]++; preRefs[v].textContent=pre[v]; save();});

  // Send
  el('#send').onclick=()=>{
    const table=el('#tbl').value; if(!table) return alert('Sélectionne d\'abord un numéro de table.');
    const items=[]; for(const v in data){for(const c in data[v]){const q=data[v][c]; if(q>0){items.push({viande:v,cuisson:c,qty:q}); if(pre[v]>0){pre[v]-=q; if(pre[v]<0) pre[v]=0; preRefs[v]&&(preRefs[v].textContent=pre[v]);}}}}
    if(!items.length) return alert('Aucune quantité sélectionnée.');
    tickets.push({id:Date.now(),table,createdAt:new Date().toLocaleTimeString(),items}); save(); renderTickets(); show('t'); renderTable();
  };

  // Done buttons (delegation)
  ticketsEl.addEventListener('click',(e)=>{const id=e.target.dataset.done; if(!id) return; tickets=tickets.filter(t=>t.id!=id); save(); renderTickets();});

  // Init
  load(); renderTable(); Object.keys(pre).forEach(k=>preRefs[k]&&(preRefs[k].textContent=pre[k])); renderTickets();

  // --- Basic tests (console) ---
  function runBasicTests(){
    const log=(ok,msg)=>console[ok?'log':'error']((ok?'✅ ':'❌ ')+msg);
    try{
      const rows=tb.querySelectorAll('tr').length; log(rows===VIANDES.length, `Nombre de lignes = ${rows} (attendu ${VIANDES.length})`);
      const cell=document.querySelector('.cell[data-v="Entrecôte"][data-c="Bleu"]');
      if(cell){
        // increment
        cell.dispatchEvent(new MouseEvent('mousedown',{bubbles:true}));
        cell.dispatchEvent(new MouseEvent('mouseup',{bubbles:true}));
        log(cell.textContent==='1', `Incrément court → ${cell.textContent}`);
        // long press reset
        cell.dispatchEvent(new MouseEvent('mousedown',{bubbles:true}));
        setTimeout(()=>{
          cell.dispatchEvent(new MouseEvent('mouseup',{bubbles:true}));
          log(cell.textContent==='0', `Appui long reset → ${cell.textContent}`);
        },800);
      } else {
        log(false,'Cellule test introuvable');
      }
    }catch(e){ console.error('❌ Tests erreur:',e); }
  }
  setTimeout(runBasicTests,100);
})();
</script>
<script>
// === PWA: manifest + service worker (tout-en-un) ===
(function(){
  // 1) Manifest dynamique via Blob
  const manifest = {
    name: "Gestion des Commandes",
    short_name: "Commandes",
    start_url: ".",
    display: "standalone",
    background_color: "#081420",
    theme_color: "#13314D",
    icons: [] // Tu pourras ajouter des icônes PNG plus tard (192/512 px)
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
  const manifestURL = URL.createObjectURL(manifestBlob);
  const link = document.getElementById('manifest-link');
  if (link) link.href = manifestURL;

  // 2) Service Worker embarqué via Blob (cache auto après 1 rechargement)
  if ('serviceWorker' in navigator) {
    const swCode = `
      const CACHE = 'gc-cache-v1';
      self.addEventListener('install', e => self.skipWaiting());
      self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
      self.addEventListener('fetch', e => {
        const r = e.request;
        if (r.method !== 'GET' || new URL(r.url).origin !== location.origin) return;
        e.respondWith(caches.open(CACHE).then(async c => {
          const hit = await c.match(r);
          if (hit) return hit;
          try {
            const res = await fetch(r);
            if (res && res.status === 200 && res.type !== 'opaque') c.put(r, res.clone());
            return res;
          } catch {
            return hit || Response.error();
          }
        }));
      });
    `;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swURL  = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL, { scope: './' }).catch(console.error);
  }
})();
</script>
</body></html>
